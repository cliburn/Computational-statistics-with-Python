

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from people.duke.edu/~ccc14/sta-663-2017/17_Functional_Programming.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Apr 2017 01:13:13 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Working with large data sets &#8212; STA-663-2017 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/cloud.base.js"></script>
    <script type="text/javascript" src="_static/cloud.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Biggish Data" href="17A_Intermediate_Sized_Data.html" />
    <link rel="prev" title="Probabilistic Graphical Models with pgmpy" href="16_PGM.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="17A_Intermediate_Sized_Data.html" title="Biggish Data"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="16_PGM.html" title="Probabilistic Graphical Models with pgmpy"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="index-2.html">STA-663-2017 1.0 documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
<div class="section" id="working-with-large-data-sets">
<h1>Working with large data sets<a class="headerlink" href="#working-with-large-data-sets" title="Permalink to this headline">¶</a></h1>
<div class="section" id="lazy-evaluation-pure-functions-and-higher-order-functions">
<h2>Lazy evaluation, pure functions and higher order functions<a class="headerlink" href="#lazy-evaluation-pure-functions-and-higher-order-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="lazy-and-eager-evaluation">
<h3>Lazy and eager evaluation<a class="headerlink" href="#lazy-and-eager-evaluation" title="Permalink to this headline">¶</a></h3>
<p>A list comprehension is <strong>eager</strong>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
<p>A generator expression is <strong>lazy</strong>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="o">&lt;</span><span class="n">genexpr</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x11d3fca40</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>You can use generators as <strong>iterators</strong>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">1</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">4</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="ne">StopIteration</span>                             <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">5</span><span class="n">f315c5de15b</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="nb">next</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>


<span class="ne">StopIteration</span><span class="p">:</span>
</pre></div>
</div>
<p>A generator is <strong>single use</strong>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
</pre></div>
</div>
<p>The list constructor forces evaluation of the generator.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
<p>An eager <strong>function</strong>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">eager_updown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xs</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">eager_updown</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>A lazy <strong>generator</strong>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lazy_updown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">lazy_updown</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="n">lazy_updown</span> <span class="n">at</span> <span class="mh">0x11d6bd990</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">lazy_updown</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="pure-and-impure-functions">
<h3>Pure and impure functions<a class="headerlink" href="#pure-and-impure-functions" title="Permalink to this headline">¶</a></h3>
<p>A pure function is like a mathematical function. Given the same inputs,
it always returns the same output, and has no side effects.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pure</span><span class="p">(</span><span class="n">alist</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">alist</span><span class="p">]</span>
</pre></div>
</div>
<p>An impure function has <strong>side effects</strong>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">impure</span><span class="p">(</span><span class="n">alist</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alist</span><span class="p">)):</span>
        <span class="n">alist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">alist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">alist</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ys</span> <span class="o">=</span> <span class="n">pure</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">ys</span> <span class="o">=</span> <span class="n">impure</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="quiz">
<h4>Quiz<a class="headerlink" href="#quiz" title="Permalink to this headline">¶</a></h4>
<p>Say if the following functions are pure or impure.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">n</span><span class="o">//</span><span class="mi">2</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">n</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f3</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">23</span>
    <span class="k">return</span> <span class="n">n</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f4</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="higher-order-functions">
<h3>Higher order functions<a class="headerlink" href="#higher-order-functions" title="Permalink to this headline">¶</a></h3>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">28</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">45</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]],</span> <span class="p">[])</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="using-the-operator-module">
<h4>Using the operator module<a class="headerlink" href="#using-the-operator-module" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal"><span class="pre">operator</span></code> module provides all the Python operators as functions.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">operator</span> <span class="k">as</span> <span class="nn">op</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">reduce</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">120</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]]))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="using-itertools">
<h4>Using itertools<a class="headerlink" href="#using-itertools" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
</pre></div>
</div>
<p>Generate all Boolean combinations</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
 <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="s1">&#39;the quick brown fox jumps over the lazy dog&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">3</span> <span class="p">[</span><span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="s1">&#39;fox&#39;</span><span class="p">,</span> <span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">]</span>
<span class="mi">4</span> <span class="p">[</span><span class="s1">&#39;over&#39;</span><span class="p">,</span> <span class="s1">&#39;lazy&#39;</span><span class="p">]</span>
<span class="mi">5</span> <span class="p">[</span><span class="s1">&#39;quick&#39;</span><span class="p">,</span> <span class="s1">&#39;brown&#39;</span><span class="p">,</span> <span class="s1">&#39;jumps&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="using-toolz">
<h4>Using toolz<a class="headerlink" href="#using-toolz" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>! pip install toolz
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">toolz</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">toolz</span> <span class="k">as</span> <span class="nn">tz</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">tz</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">tz</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">pad</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">dna</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;ACTG&#39;</span><span class="p">),</span> <span class="n">n</span><span class="p">))</span>
<span class="n">dna</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;TGCGTACTTTTCGCTATCCTCTAGTAGTTG&#39;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">tz</span><span class="o">.</span><span class="n">frequencies</span><span class="p">(</span><span class="n">tz</span><span class="o">.</span><span class="n">sliding_window</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dna</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="using-pipes-and-the-curried-namespace">
<h4>Using pipes and the curried namespace<a class="headerlink" href="#using-pipes-and-the-curried-namespace" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">toolz</span> <span class="k">import</span> <span class="n">curried</span> <span class="k">as</span> <span class="n">c</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">tz</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
    <span class="n">dna</span><span class="p">,</span>
    <span class="n">c</span><span class="o">.</span><span class="n">sliding_window</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="c1"># using curry</span>
    <span class="n">c</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">}</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">composed</span> <span class="o">=</span> <span class="n">tz</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span>
    <span class="n">c</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span>
    <span class="n">c</span><span class="o">.</span><span class="n">sliding_window</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">composed</span><span class="p">(</span><span class="n">dna</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">4</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="processing-many-sets-of-dna-strings-without-reading-into-memory">
<h4>Processing many sets of DNA strings without reading into memory<a class="headerlink" href="#processing-many-sets-of-dna-strings-without-reading-into-memory" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">dnas</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s1">&#39;ACTG&#39;</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
<span class="n">dnas</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">generator</span> <span class="nb">object</span> <span class="o">&lt;</span><span class="n">genexpr</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x11d6bddb0</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">tz</span><span class="o">.</span><span class="n">merge_with</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span>
              <span class="n">tz</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                  <span class="n">composed</span><span class="p">,</span>
                  <span class="n">dnas</span>
              <span class="p">)</span>
             <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span> <span class="mi">29994</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">59620</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">120072</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">89211</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span> <span class="mi">59860</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">119228</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">238914</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">179708</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span> <span class="mi">119757</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">239565</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">478575</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">359070</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">):</span> <span class="mi">89249</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span> <span class="mi">179377</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span> <span class="mi">359409</span><span class="p">,</span>
 <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">):</span> <span class="mi">268391</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="working-with-out-of-core-memory">
<h2>Working with out-of-core memory<a class="headerlink" href="#working-with-out-of-core-memory" title="Permalink to this headline">¶</a></h2>
<div class="section" id="using-memmap">
<h3>Using <code class="docutils literal"><span class="pre">memmap</span></code><a class="headerlink" href="#using-memmap" title="Permalink to this headline">¶</a></h3>
<p>You can selectively retrieve parts of <code class="docutils literal"><span class="pre">numpy</span></code> arrays stored on disk
into memory for processing with <code class="docutils literal"><span class="pre">memmap</span></code>.</p>
<p>Memory-mapped files are used for accessing small segments of large files
on disk, without reading the entire file into memory. The
<code class="docutils literal"><span class="pre">numpy.memmap</span></code> can be used anywhere an <code class="docutils literal"><span class="pre">ndarray</span></code> is used. The
maximum size of a <code class="docutils literal"><span class="pre">memmap</span></code> array is limited by what the operating
system allows - in particular, this is different on 32 and 64 bit
architectures.</p>
<div class="section" id="creating-the-memory-mapped-file">
<h4>Creating the memory mapped file<a class="headerlink" href="#creating-the-memory-mapped-file" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;random.dat&#39;</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># create memmap</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># store some data in it</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

<span class="c1"># flush to disk and remove file handler</span>
<span class="k">del</span> <span class="n">fp</span>
</pre></div>
</div>
</div>
<div class="section" id="usign-the-memory-mapped-file">
<h4>Usign the memory mapped file<a class="headerlink" href="#usign-the-memory-mapped-file" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># only one block is retreived into memory at a time</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="s1">&#39;Total: </span><span class="si">%.2f</span><span class="s1">s Per file: </span><span class="si">%.2f</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">elapsed</span><span class="o">/</span><span class="n">n</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">0.500001143637</span> <span class="n">Total</span><span class="p">:</span> <span class="mf">0.64</span><span class="n">s</span> <span class="n">Per</span> <span class="n">file</span><span class="p">:</span> <span class="mf">0.01</span><span class="n">s</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-hdf5">
<h3>Using HDF5<a class="headerlink" href="#using-hdf5" title="Permalink to this headline">¶</a></h3>
<p>HDF5 is a hierarchical file format that allows selective disk reads, but
also provides a tree structure for organizing your data sets. It can
also include metadata annotation for documentation. Because of its
flexibility, you should seriously consider using HDF5 for your data
storage needs.</p>
<p>I suggest using the python package <code class="docutils literal"><span class="pre">h5py</span></code> for working with HDF5 files.
See <a class="reference external" href="http://docs.h5py.org/en/latest/">documentation</a>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">h5py</span>
</pre></div>
</div>
<div class="section" id="creating-an-hdf5-file">
<h4>Creating an HDF5 file<a class="headerlink" href="#creating-an-hdf5-file" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;random.hdf5&#39;</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Sim</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

<span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1"># Create hierarchical group structure</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="c1"># Add metadata for each group</span>
        <span class="n">g</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="c1"># Save 100 arrays in each group</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;x</span><span class="si">%06d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">dset</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="c1"># Add metadata for each array</span>
            <span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">701</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">124</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">825</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">920</span> <span class="n">ms</span>
</pre></div>
</div>
</div>
<div class="section" id="using-an-hdf5-file">
<h4>Using an HDF5 file<a class="headerlink" href="#using-an-hdf5-file" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;random.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The HDF5 objects can be treated like dictionaries.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Sim00</span>
<span class="n">Sim01</span>
<span class="n">Sim02</span>
<span class="n">Sim03</span>
<span class="n">Sim04</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Sim00</span>
<span class="n">Sim01</span>
<span class="n">Sim02</span>
<span class="n">Sim03</span>
<span class="n">Sim04</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">sim1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sim01&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">sim1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;x000000&#39;</span><span class="p">,</span> <span class="s1">&#39;x000001&#39;</span><span class="p">,</span> <span class="s1">&#39;x000002&#39;</span><span class="p">,</span> <span class="s1">&#39;x000003&#39;</span><span class="p">,</span> <span class="s1">&#39;x000004&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Or recursed through like trees</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Sim00</span>
<span class="n">Sim00</span><span class="o">/</span><span class="n">x000000</span>
<span class="n">Sim00</span><span class="o">/</span><span class="n">x000001</span>
<span class="n">Sim00</span><span class="o">/</span><span class="n">x000002</span>
<span class="n">Sim00</span><span class="o">/</span><span class="n">x000003</span>
<span class="n">Sim00</span><span class="o">/</span><span class="n">x000004</span>
<span class="n">Sim01</span>
<span class="n">Sim01</span><span class="o">/</span><span class="n">x000000</span>
<span class="n">Sim01</span><span class="o">/</span><span class="n">x000001</span>
<span class="n">Sim01</span><span class="o">/</span><span class="n">x000002</span>
<span class="n">Sim01</span><span class="o">/</span><span class="n">x000003</span>
<span class="n">Sim01</span><span class="o">/</span><span class="n">x000004</span>
<span class="n">Sim02</span>
<span class="n">Sim02</span><span class="o">/</span><span class="n">x000000</span>
<span class="n">Sim02</span><span class="o">/</span><span class="n">x000001</span>
<span class="n">Sim02</span><span class="o">/</span><span class="n">x000002</span>
<span class="n">Sim02</span><span class="o">/</span><span class="n">x000003</span>
<span class="n">Sim02</span><span class="o">/</span><span class="n">x000004</span>
<span class="n">Sim03</span>
<span class="n">Sim03</span><span class="o">/</span><span class="n">x000000</span>
<span class="n">Sim03</span><span class="o">/</span><span class="n">x000001</span>
<span class="n">Sim03</span><span class="o">/</span><span class="n">x000002</span>
<span class="n">Sim03</span><span class="o">/</span><span class="n">x000003</span>
<span class="n">Sim03</span><span class="o">/</span><span class="n">x000004</span>
<span class="n">Sim04</span>
<span class="n">Sim04</span><span class="o">/</span><span class="n">x000000</span>
<span class="n">Sim04</span><span class="o">/</span><span class="n">x000001</span>
<span class="n">Sim04</span><span class="o">/</span><span class="n">x000002</span>
<span class="n">Sim04</span><span class="o">/</span><span class="n">x000003</span>
<span class="n">Sim04</span><span class="o">/</span><span class="n">x000004</span>
</pre></div>
</div>
<p>Retrieving data and attributes</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">sim2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sim02&#39;</span><span class="p">)</span>
<span class="n">sim2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;2017-03-29 16:19:19.613896&#39;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">sim2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x000003&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">float32</span>
<span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">29</span> <span class="mi">16</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mf">19.749793</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">0.49980888</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-sqlite3">
<h3>Using SQLite3<a class="headerlink" href="#using-sqlite3" title="Permalink to this headline">¶</a></h3>
<p>When data is on a relational database, it is useful to do as much
preprocessing as possible using SQL - this will be performed using
highly efficient compiled routines on the (potentially remote) computer
where the database exists.</p>
<p>Here we will use SQLite3 together with <code class="docutils literal"><span class="pre">pandas</span></code> to summarize a
(potentially) large database.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">create_engine</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///data/movies.db&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">SELECT year, count(*) as number</span>
<span class="s1">FROM data</span>
<span class="s1">GROUP BY year</span>
<span class="s1">ORDER BY number DESC</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="c1"># The coounting, grouping and sorting is done by the database, not pandas</span>
<span class="c1"># So this query will work even if the movies dataabse is many terabytes in size</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1996</td>
      <td>1375</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2000</td>
      <td>1365</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1998</td>
      <td>1360</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2002</td>
      <td>1360</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1997</td>
      <td>1335</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="out-of-memory-data-conversions">
<h3>Out-of-memory data conversions<a class="headerlink" href="#out-of-memory-data-conversions" title="Permalink to this headline">¶</a></h3>
<p>There is a convenient Python package called <code class="docutils literal"><span class="pre">odo</span></code> that will convert
data between different formats without having to load all the data into
memory first. This allows conversion of potentially huge files.</p>
<p><a class="reference external" href="http://www.startrek.com/database_article/odo">Odo</a> is a shape
shifting character in the Star Trek universe.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>! pip install odo
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">odo</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">datashape</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="o">.</span><span class="mi">0</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">numpy</span><span class="o">&gt;=</span><span class="mf">1.7</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">pandas</span><span class="o">&gt;=</span><span class="mf">0.15</span><span class="o">.</span><span class="mi">0</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">toolz</span><span class="o">&gt;=</span><span class="mf">0.7</span><span class="o">.</span><span class="mi">3</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">multipledispatch</span><span class="o">&gt;=</span><span class="mf">0.4</span><span class="o">.</span><span class="mi">7</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">networkx</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">python</span><span class="o">-</span><span class="n">dateutil</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">datashape</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="o">.</span><span class="mi">0</span><span class="o">-&gt;</span><span class="n">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">pytz</span><span class="o">&gt;=</span><span class="mi">2011</span><span class="n">k</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">pandas</span><span class="o">&gt;=</span><span class="mf">0.15</span><span class="o">.</span><span class="mi">0</span><span class="o">-&gt;</span><span class="n">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">decorator</span><span class="o">&gt;=</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">0</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">networkx</span><span class="o">-&gt;</span><span class="n">odo</span><span class="p">)</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">six</span><span class="o">&gt;=</span><span class="mf">1.5</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">python</span><span class="o">-</span><span class="n">dateutil</span><span class="o">-&gt;</span><span class="n">datashape</span><span class="o">&gt;=</span><span class="mf">0.5</span><span class="o">.</span><span class="mi">0</span><span class="o">-&gt;</span><span class="n">odo</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">odo</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">odo</span><span class="o">.</span><span class="n">odo</span><span class="p">(</span><span class="s1">&#39;sqlite:///data/movies.db::data&#39;</span><span class="p">,</span> <span class="s1">&#39;data/movies.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">odo</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">CSV</span> <span class="n">at</span> <span class="mh">0x1503c7828</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>! head data/movies.csv
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">index</span><span class="p">,</span><span class="n">movieId</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">genres</span><span class="p">,</span><span class="n">year</span>
<span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Toy Story (1995)&quot;</span><span class="p">,</span><span class="n">Adventure</span><span class="o">|</span><span class="n">Animation</span><span class="o">|</span><span class="n">Children</span><span class="o">|</span><span class="n">Comedy</span><span class="o">|</span><span class="n">Fantasy</span><span class="p">,</span><span class="mi">1995</span>
<span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Jumanji (1995)&quot;</span><span class="p">,</span><span class="n">Adventure</span><span class="o">|</span><span class="n">Children</span><span class="o">|</span><span class="n">Fantasy</span><span class="p">,</span><span class="mi">1995</span>
<span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;Grumpier Old Men (1995)&quot;</span><span class="p">,</span><span class="n">Comedy</span><span class="o">|</span><span class="n">Romance</span><span class="p">,</span><span class="mi">1995</span>
<span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s2">&quot;Waiting to Exhale (1995)&quot;</span><span class="p">,</span><span class="n">Comedy</span><span class="o">|</span><span class="n">Drama</span><span class="o">|</span><span class="n">Romance</span><span class="p">,</span><span class="mi">1995</span>
<span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;Father of the Bride Part II (1995)&quot;</span><span class="p">,</span><span class="n">Comedy</span><span class="p">,</span><span class="mi">1995</span>
<span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="s2">&quot;Heat (1995)&quot;</span><span class="p">,</span><span class="n">Action</span><span class="o">|</span><span class="n">Crime</span><span class="o">|</span><span class="n">Thriller</span><span class="p">,</span><span class="mi">1995</span>
<span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="s2">&quot;Sabrina (1995)&quot;</span><span class="p">,</span><span class="n">Comedy</span><span class="o">|</span><span class="n">Romance</span><span class="p">,</span><span class="mi">1995</span>
<span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s2">&quot;Tom and Huck (1995)&quot;</span><span class="p">,</span><span class="n">Adventure</span><span class="o">|</span><span class="n">Children</span><span class="p">,</span><span class="mi">1995</span>
<span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;Sudden Death (1995)&quot;</span><span class="p">,</span><span class="n">Action</span><span class="p">,</span><span class="mi">1995</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="probabilistic-data-structures">
<h2>Probabilistic data structures<a class="headerlink" href="#probabilistic-data-structures" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal"><span class="pre">data</span> <span class="pre">sketch</span></code> is a probabilistic algorithm or data structure that
approximates some statistic of interest, typically using very little
memory and processing time. Often they are applied to streaming data,
and so must be able to incrementally process data. Many data sketches
make use of hash functions to distribute data into buckets uniformly.
Typically, data sketches have the following desirable properties</p>
<ul class="simple">
<li>sub-linear in space</li>
<li>single scan</li>
<li>can be parallelized</li>
<li>can be combined (merge)</li>
</ul>
<p>Examples where counting distinct values is useful:</p>
<ul class="simple">
<li>number of unique users in a Twitter stream</li>
<li>number of distinct records to be fetched by a database query</li>
<li>number of unique IP addresses accessing a website</li>
<li>number of distinct queries submitted to a search engine</li>
<li>number of distinct DNA motifs in genomics data sets (e.g. microbiome)</li>
</ul>
<p>Packages for data sketches in Python are relatively immature, and if you
are interested, you could make a large contribution by creating a
comprehensive open source library of data sketches in Python.</p>
<div class="section" id="hyperloglog">
<h3>HyperLogLog<a class="headerlink" href="#hyperloglog" title="Permalink to this headline">¶</a></h3>
<p>Counting the number of <strong>distinct</strong> elements exactly requires storage of
all distinct elements (e.g. in a set) and hence grows with the
cardinality <span class="math">\(n\)</span>. Probabilistic data structures known as Distinct
Value Sketches can do this with a tiny and fixed memory size.</p>
<p>A hash function takes data of arbitrary size and converts it into a
number in a fixed range. Ideally, given an arbitrary set of data items,
the hash function generates numbers that follow a uniform distribution
within the fixed range. Hash functions are immensely useful throughout
computer science (for example - they power Python sets and
dictionaries), and especially for the generation of probabilistic data
structures.</p>
<p>The binary digits in a (say) 32-bit hash are effectively random, and
equivalent to a sequence of fair coin tosses. Hence the probability that
we see a run of 5 zeros in the smallest hash so far suggests that we
have added <span class="math">\(2^5\)</span> unique items so far. This is the intuition behind
the loglog family of Distinct Value Sketches. Note that the biggest
count we can track with 32 bits is <span class="math">\(2^{32} = 4294967296\)</span>.</p>
<p>The accuracy of the sketch can be improved by averaging results with
multiple coin flippers. In practice, this is done by using the first
<span class="math">\(k\)</span> bit registers to identify <span class="math">\(2^k\)</span> different coin flippers.
Hence, the max count is now <span class="math">\(2 ** (32 - k)\)</span>. The hyperloglog
algorithm uses the harmonic mean of the <span class="math">\(2^k\)</span> flippers which
reduces the effect of outliers and hence the variance of the estimate.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>! pip install hyperloglog
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">hyperloglog</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hyperloglog</span> <span class="k">import</span> <span class="n">HyperLogLog</span>
</pre></div>
</div>
<div class="section" id="compare-unique-counts-with-set-and-hyperloglog">
<h4>Compare unique counts with set and hyperloglog<a class="headerlink" href="#compare-unique-counts-with-set-and-hyperloglog" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">xs</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">/</span><span class="n">n</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;True</span><span class="se">\t\t</span><span class="s1">HLL</span><span class="se">\t\t</span><span class="s1">Rel Error&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/Ulysses.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">word_list</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">hll</span> <span class="o">=</span> <span class="n">HyperLogLog</span><span class="p">(</span><span class="n">error_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">word_list</span><span class="p">):</span>
        <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">hll</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="n">e5</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%8d</span><span class="se">\t</span><span class="si">%8d</span><span class="se">\t\t</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">hll</span><span class="p">),</span>
                   <span class="mi">0</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">error</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">hll</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kc">True</span>                <span class="n">HLL</span>             <span class="n">Rel</span> <span class="n">Error</span>
       <span class="mi">1</span>           <span class="mi">1</span>                <span class="mf">0.000</span>
    <span class="mi">7095</span>        <span class="mi">7151</span>                <span class="mf">0.003</span>
   <span class="mi">11582</span>       <span class="mi">11667</span>                <span class="mf">0.002</span>
   <span class="mi">16010</span>       <span class="mi">16202</span>                <span class="mf">0.003</span>
   <span class="mi">20058</span>       <span class="mi">20296</span>                <span class="mf">0.003</span>
   <span class="mi">23761</span>       <span class="mi">24087</span>                <span class="mf">0.003</span>
   <span class="mi">27463</span>       <span class="mi">27785</span>                <span class="mf">0.003</span>
   <span class="mi">29780</span>       <span class="mi">30173</span>                <span class="mf">0.003</span>
   <span class="mi">33740</span>       <span class="mi">34206</span>                <span class="mf">0.003</span>
   <span class="mi">38070</span>       <span class="mi">38473</span>                <span class="mf">0.002</span>
   <span class="mi">41599</span>       <span class="mi">42235</span>                <span class="mf">0.003</span>
   <span class="mi">44119</span>       <span class="mi">44619</span>                <span class="mf">0.002</span>
   <span class="mi">48549</span>       <span class="mi">49197</span>                <span class="mf">0.003</span>
   <span class="mi">49511</span>       <span class="mi">50191</span>                <span class="mf">0.003</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="bloom-filters">
<h3>Bloom filters<a class="headerlink" href="#bloom-filters" title="Permalink to this headline">¶</a></h3>
<p>Bloom filters are designed to answer queries about whether a specific
item is in a collection. If the answer is NO, then it is definitive.
However, if the answer is yes, it might be a false positive. The
possibility of a false positive makes the Bloom filter a probabilistic
data structure.</p>
<p>A bloom filter consists of a bit vector of length <span class="math">\(k\)</span> initially
set to zero, and <span class="math">\(n\)</span> different hash functions that return a hash
value that will fall into one of the <span class="math">\(k\)</span> bins. In the construction
phase, for every item in the collection, <span class="math">\(n\)</span> hash values are
generated by the <span class="math">\(n\)</span> hash functions, and every position indicated
by a hash value is flipped to one. In the query phase, given an item,
<span class="math">\(n\)</span> hash values are calculated as before - if any of these
<span class="math">\(n\)</span> positions is a zero, then the item is definitely not in the
collection. However, because of the possibility of hash collisions, even
if all the positions are one, this could be a false positive. Clearly,
the rate of false positives depends on the ratio of zero and one bits,
and there are Bloom filter implementations that will dynamically bound
the ratio and hence the false positive rate.</p>
<p>Possible uses of a Bloom filter include:</p>
<ul class="simple">
<li>Does a particular sequence motif appear in a DNA string?</li>
<li>Has this book been recommended to this customer before?</li>
<li>Check if an element exists on disk before performing I/O</li>
<li>Check if URL is a potential malware site using in-browser Bloom
filter to minimize network communication</li>
<li>As an alternative way to generate distinct value counts cheaply (only
increment count if Bloom filter says NO)</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>! pip install git+https://github.com/jaybaird/python-bloomfilter.git
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Collecting</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jaybaird</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">bloomfilter</span><span class="o">.</span><span class="n">git</span>
  <span class="n">Cloning</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jaybaird</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">bloomfilter</span><span class="o">.</span><span class="n">git</span> <span class="n">to</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="n">xf</span><span class="o">/</span><span class="n">rzdg30ps11g93j3w0h589q780000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">pip</span><span class="o">-</span><span class="mi">4</span><span class="n">g7j8fys</span><span class="o">-</span><span class="n">build</span>
  <span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span> <span class="p">(</span><span class="n">use</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">to</span> <span class="n">upgrade</span><span class="p">):</span> <span class="n">pybloom</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">0</span> <span class="kn">from</span> <span class="nn">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jaybaird</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">bloomfilter</span><span class="o">.</span><span class="n">git</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span>
<span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">bitarray</span><span class="o">&gt;=</span><span class="mf">0.3</span><span class="o">.</span><span class="mi">4</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">pybloom</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pybloom</span> <span class="k">import</span> <span class="n">ScalableBloomFilter</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># The Scalable Bloom Filter grows as needed to keep the error rate small</span>
<span class="n">sbf</span> <span class="o">=</span> <span class="n">ScalableBloomFilter</span><span class="p">(</span><span class="n">error_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/Ulysses.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">word_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_set</span><span class="p">:</span>
        <span class="n">sbf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="ask-bloom-filter-if-test-words-were-in-ulysses">
<h4>Ask Bloom filter if test words were in Ulysses<a class="headerlink" href="#ask-bloom-filter-if-test-words-were-in-ulysses" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">test_words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;artist&#39;</span><span class="p">,</span> <span class="s1">&#39;Dublin&#39;</span><span class="p">,</span> <span class="s1">&#39;masochist&#39;</span><span class="p">,</span> <span class="s1">&#39;Obama&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">test_words</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sbf</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">banana</span> <span class="kc">True</span>
<span class="n">artist</span> <span class="kc">True</span>
<span class="n">Dublin</span> <span class="kc">True</span>
<span class="n">masochist</span> <span class="kc">False</span>
<span class="n">Obama</span> <span class="kc">False</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">test_words</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">word_set</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">banana</span> <span class="kc">True</span>
<span class="n">artist</span> <span class="kc">True</span>
<span class="n">Dublin</span> <span class="kc">True</span>
<span class="n">masochist</span> <span class="kc">False</span>
<span class="n">Obama</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="small-scale-distributed-programming">
<h2>Small-scale distributed programming<a class="headerlink" href="#small-scale-distributed-programming" title="Permalink to this headline">¶</a></h2>
<div class="section" id="using-dask">
<h3>Using <code class="docutils literal"><span class="pre">dask</span></code><a class="headerlink" href="#using-dask" title="Permalink to this headline">¶</a></h3>
<p>For data sets that are not too big (say up to 1 TB), it is typically
sufficient to process on a single workstation. The package dask provides
3 data structures that mimic regular Python data structures but perform
computation in a distributed way allowing you to make optimal use of
multiple cores easily.</p>
<p>These structures are</p>
<ul class="simple">
<li>dask array ~ numpy array</li>
<li>dask bag ~ Python dictionary</li>
<li>dask dataframe ~ pandas dataframe</li>
</ul>
<p>From the <a class="reference external" href="http://dask.pydata.org/en/latest/index.html">official
documentation</a>,</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Dask</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">task</span> <span class="n">scheduling</span> <span class="n">system</span> <span class="n">that</span> <span class="n">uses</span> <span class="n">directed</span> <span class="n">acyclic</span> <span class="n">graphs</span> <span class="p">(</span><span class="n">DAGs</span><span class="p">)</span> <span class="n">of</span> <span class="n">tasks</span> <span class="n">to</span> <span class="k">break</span> <span class="n">up</span> <span class="n">large</span> <span class="n">computations</span> <span class="n">into</span> <span class="n">many</span> <span class="n">small</span> <span class="n">ones</span><span class="o">.</span>

<span class="n">Dask</span> <span class="n">enables</span> <span class="n">parallel</span> <span class="n">computing</span> <span class="n">through</span> <span class="n">task</span> <span class="n">scheduling</span> <span class="ow">and</span> <span class="n">blocked</span> <span class="n">algorithms</span><span class="o">.</span> <span class="n">This</span> <span class="n">allows</span> <span class="n">developers</span> <span class="n">to</span> <span class="n">write</span>    <span class="nb">complex</span> <span class="n">parallel</span> <span class="n">algorithms</span> <span class="ow">and</span> <span class="n">execute</span> <span class="n">them</span> <span class="ow">in</span> <span class="n">parallel</span> <span class="n">either</span> <span class="n">on</span> <span class="n">a</span> <span class="n">modern</span> <span class="n">multi</span><span class="o">-</span><span class="n">core</span> <span class="n">machine</span> <span class="ow">or</span> <span class="n">on</span> <span class="n">a</span> <span class="n">distributed</span> <span class="n">cluster</span><span class="o">.</span>

<span class="n">On</span> <span class="n">a</span> <span class="n">single</span> <span class="n">machine</span> <span class="n">dask</span> <span class="n">increases</span> <span class="n">the</span> <span class="n">scale</span> <span class="n">of</span> <span class="n">comfortable</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">fits</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">memory</span> <span class="n">to</span> <span class="n">fits</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">disk</span> <span class="n">by</span> <span class="n">intelligently</span> <span class="n">streaming</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">disk</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">leveraging</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">cores</span> <span class="n">of</span> <span class="n">a</span> <span class="n">modern</span> <span class="n">CPU</span><span class="o">.</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>! pip install dask
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">dask</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">dask.bag</span> <span class="k">as</span> <span class="nn">db</span>
<span class="kn">import</span> <span class="nn">dask.dataframe</span> <span class="k">as</span> <span class="nn">dd</span>
</pre></div>
</div>
<div class="section" id="dask-arrays">
<h4><code class="docutils literal"><span class="pre">dask</span></code> arrays<a class="headerlink" href="#dask-arrays" title="Permalink to this headline">¶</a></h4>
<p>These behave like <code class="docutils literal"><span class="pre">numpy</span></code> arrays, but break a massive job into
<strong>tasks</strong> that are then executed by a <strong>scheduler</strong>. The default
scheduler uses threading but you can also use multiprocessing or
distributed or even serial processing (mainly for debugging). You can
tell the dask array how to break the data into <strong>chunks</strong> for
processing.</p>
<p>From official documents</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>For performance, a good choice of chunks follows the following rules:

A chunk should be small enough to fit comfortably in memory. We’ll have many chunks in memory at once.
A chunk must be large enough so that computations on that chunk take significantly longer than the 1ms overhead per task that dask scheduling incurs. A task should take longer than 100ms.
Chunks should align with the computation that you want to do. For example if you plan to frequently slice along a particular dimension then it’s more efficient if your chunks are aligned so that you have to touch fewer chunks. If you want to add two arrays then its convenient if those arrays have matching chunks patterns.
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># We resuse the 100 * 1000 * 1000 random numbers in the memmap file on disk</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;random.dat&#39;</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># We can decide on the chunk size to be distributed for computing</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">500</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="n">avg</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">avg</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">0.50000114363730053</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Typically we store Dask arrays inot HDF5</span>

<span class="n">da</span><span class="o">.</span><span class="n">to_hdf5</span><span class="p">(</span><span class="s1">&#39;data/xs.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;/foo/xs&#39;</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;data/xs.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/foo/xs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="dask-data-frames">
<h4><code class="docutils literal"><span class="pre">dask</span></code> data frames<a class="headerlink" href="#dask-data-frames" title="Permalink to this headline">¶</a></h4>
<p>Dask dataframes can treat multiple pandas dataframes that might not
simultaneously fit into memory like a single dataframe. See use of
globbing to specify multiple source files.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;data/x</span><span class="si">%03d</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/x*.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>                 <span class="mi">0</span>            <span class="mi">1</span>            <span class="mi">2</span>            <span class="mi">3</span>            <span class="mi">4</span>
<span class="n">count</span>  <span class="mf">5000.000000</span>  <span class="mf">5000.000000</span>  <span class="mf">5000.000000</span>  <span class="mf">5000.000000</span>  <span class="mf">5000.000000</span>
<span class="n">mean</span>      <span class="mf">0.492787</span>     <span class="mf">0.498913</span>     <span class="mf">0.506285</span>     <span class="mf">0.497849</span>     <span class="mf">0.496456</span>
<span class="n">std</span>       <span class="mf">0.290051</span>     <span class="mf">0.290067</span>     <span class="mf">0.289115</span>     <span class="mf">0.287252</span>     <span class="mf">0.288440</span>
<span class="nb">min</span>       <span class="mf">0.000120</span>     <span class="mf">0.000127</span>     <span class="mf">0.001602</span>     <span class="mf">0.000124</span>     <span class="mf">0.000028</span>
<span class="mi">25</span><span class="o">%</span>       <span class="mf">0.270114</span>     <span class="mf">0.261522</span>     <span class="mf">0.267837</span>     <span class="mf">0.262800</span>     <span class="mf">0.262552</span>
<span class="mi">50</span><span class="o">%</span>       <span class="mf">0.511363</span>     <span class="mf">0.525779</span>     <span class="mf">0.522839</span>     <span class="mf">0.515185</span>     <span class="mf">0.511809</span>
<span class="mi">75</span><span class="o">%</span>       <span class="mf">0.762856</span>     <span class="mf">0.755237</span>     <span class="mf">0.761059</span>     <span class="mf">0.761570</span>     <span class="mf">0.772811</span>
<span class="nb">max</span>       <span class="mf">0.999914</span>     <span class="mf">0.999940</span>     <span class="mf">0.999997</span>     <span class="mf">0.999718</span>     <span class="mf">0.999783</span>
</pre></div>
</div>
</div>
<div class="section" id="dask-bags">
<h4><code class="docutils literal"><span class="pre">dask</span></code> bags<a class="headerlink" href="#dask-bags" title="Permalink to this headline">¶</a></h4>
<p>Dask bags work like dictionaries for unstructured or semi-structured
data sets, typically over many files.</p>
</div>
<div class="section" id="the-aa-subdirectory-consists-of-101-1-mb-plain-text-files-from-the-english-wikipedia">
<h4>The AA subdirectory consists of 101 1 MB plain text files from the English Wikipedia<a class="headerlink" href="#the-aa-subdirectory-consists-of-101-1-mb-plain-text-files-from-the-english-wikipedia" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s1">&#39;data/wiki/AA/*&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>

<span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">top10</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">1</span><span class="nb">min</span> <span class="mi">12</span><span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mf">2.27</span> <span class="n">s</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">1</span><span class="nb">min</span> <span class="mi">14</span><span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">1</span><span class="nb">min</span> <span class="mi">27</span><span class="n">s</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">top10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="mi">1051994</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="mi">617239</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="mi">482039</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="mi">370266</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="mi">356495</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">312597</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="mi">174145</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="mi">145215</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;was&#39;</span><span class="p">,</span> <span class="mi">141788</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;The&#39;</span><span class="p">,</span> <span class="mi">141724</span><span class="p">)]</span>
</pre></div>
</div>
<p>This is slow because of disk access. Fix by changing scheduler to work
asynchronously.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>

<span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">top10</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">get</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="k">async</span><span class="o">.</span><span class="n">get_sync</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mf">11.1</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">413</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mf">11.6</span> <span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">11.8</span> <span class="n">s</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">top10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;the&#39;</span><span class="p">,</span> <span class="mi">1051994</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="mi">617239</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="mi">482039</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="mi">370266</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="mi">356495</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">312597</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="mi">174145</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="mi">145215</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;was&#39;</span><span class="p">,</span> <span class="mi">141788</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;The&#39;</span><span class="p">,</span> <span class="mi">141724</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="section" id="conversion-from-bag-to-dataframe">
<h4>Conversion from bag to dataframe<a class="headerlink" href="#conversion-from-bag-to-dataframe" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">freqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="o">.</span>
         <span class="nb">str</span><span class="o">.</span><span class="n">translate</span><span class="p">({</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">):</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">})</span><span class="o">.</span>
         <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span>
         <span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span>
         <span class="n">concat</span><span class="p">()</span><span class="o">.</span>
         <span class="n">frequencies</span><span class="p">())</span>
</pre></div>
</div>
<div class="section" id="get-the-top-5-words-sorted-by-key-not-value">
<h5>Get the top 5 words sorted by key (not value)<a class="headerlink" href="#get-the-top-5-words-sorted-by-key-not-value" title="Permalink to this headline">¶</a></h5>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">freqs</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">get</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="k">async</span><span class="o">.</span><span class="n">get_sync</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;🚲&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;𝛿&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;𓏘𓃭𓇋𓍯𓊪𓄿𓂧𓂋𓄿𓏏𓆇&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;𒀸𒋗𒁺&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;𐑅&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df_freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">])</span>
<span class="n">df_freqs</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>word</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>€53</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>doodnath</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>iphone</td>
      <td>82</td>
    </tr>
    <tr>
      <th>3</th>
      <td>flagged</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>desks</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="section" id="the-compute-method-converts-to-a-regular-pandas-dataframe">
<h4>The compute method converts to a regular pandas dataframe<a class="headerlink" href="#the-compute-method-converts-to-a-regular-pandas-dataframe" title="Permalink to this headline">¶</a></h4>
<p>For data sets that fit in memory, pandas is faster and allows some
operations like sorting that are not provided by dask dataframes.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_freqs</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>word</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>16770</th>
      <td>🚲</td>
      <td>1</td>
    </tr>
    <tr>
      <th>313069</th>
      <td>𝛿</td>
      <td>2</td>
    </tr>
    <tr>
      <th>137307</th>
      <td>𓏘𓃭𓇋𓍯𓊪𓄿𓂧𓂋𓄿𓏏𓆇</td>
      <td>1</td>
    </tr>
    <tr>
      <th>103308</th>
      <td>𒀸𒋗𒁺</td>
      <td>1</td>
    </tr>
    <tr>
      <th>326342</th>
      <td>𐑅</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="index-2.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="00_Jupyter.html">Notes on using Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_Introduction_To_Python.html">Introduction to Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Classes.html">Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_Strings.html">Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_Numbers.html">Using <code class="docutils literal"><span class="pre">numpy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="06_Graphics.html">Graphics in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_Data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_SQL.html">SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_Machine_Learning.html">Machine Learning with <code class="docutils literal"><span class="pre">sklearn</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="10A_CodeOptimization.html">Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="10B_Numba.html">Just-in-time compilation (JIT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="10C_Cython.html">Cython</a></li>
<li class="toctree-l1"><a class="reference internal" href="11A_Parallel_Programming.html">Parallel Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="11B_Threads_Processses_Concurrency.html">Multi-Core Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="11C_IPyParallel.html">Using <code class="docutils literal"><span class="pre">ipyparallel</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="12A_C%2b%2b.html">Using C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="12B_C%2b%2b_Python_pybind11.html">Using <code class="docutils literal"><span class="pre">pybind11</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="13A_LinearAlgebra1.html">Linear Algebra Review</a></li>
<li class="toctree-l1"><a class="reference internal" href="13A_LinearAlgebra1.html#linear-algebra-and-linear-systems">Linear Algebra and Linear Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="13B_LinearAlgebra2.html">Matrix Decompositions</a></li>
<li class="toctree-l1"><a class="reference internal" href="13C_LinearAlgebraExamples.html">Linear Algebra Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="13D_PCA.html">Applications of Linear Alebra: PCA</a></li>
<li class="toctree-l1"><a class="reference internal" href="13E_SparseMatrices.html">Sparse Matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="14A_Optimization_One_Dimension.html">Optimization and Root Finding</a></li>
<li class="toctree-l1"><a class="reference internal" href="14B_Multivariate_Optimization.html">Algorithms for Optimization and Root Finding for Multivariate Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="14C_Optimization_In_Python.html">Using optimization routines from <code class="docutils literal"><span class="pre">scipy</span></code> and <code class="docutils literal"><span class="pre">statsmodels</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="15A_Random_Numbers.html">Random numbers and probability models</a></li>
<li class="toctree-l1"><a class="reference internal" href="15B_ResamplingAndSimulation.html">Resampling and Monte Carlo Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="15C_MonteCarloIntegration.html">Numerical Evaluation of Integrals</a></li>
<li class="toctree-l1"><a class="reference internal" href="16_PGM.html">Probabilistic Graphical Models with <code class="docutils literal"><span class="pre">pgmpy</span></code></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Working with large data sets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lazy-evaluation-pure-functions-and-higher-order-functions">Lazy evaluation, pure functions and higher order functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-out-of-core-memory">Working with out-of-core memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#probabilistic-data-structures">Probabilistic data structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="#small-scale-distributed-programming">Small-scale distributed programming</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="17A_Intermediate_Sized_Data.html">Biggish Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="17B_Big_Data_Structures.html">Efficient storage of data in memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="18A_Dask.html">Working with large data sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="10B_Numba.html">Just-in-time compilation (JIT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="18B_Spark.html">Using Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="18C_Efficiency_In_Spark.html">Using Spark Efficiently</a></li>
<li class="toctree-l1"><a class="reference internal" href="18D_Spark_MLib.html">Spark MLLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="18E_Spark_SQL.html">Spark SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="18G_Spark_Streaming.html">Spark Streaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="18H_Spark_Cloud.html">Spark on Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="19A_PyMC3.html">Using PyMC3</a></li>
<li class="toctree-l1"><a class="reference internal" href="19B_Pystan.html">PyStan</a></li>
<li class="toctree-l1"><a class="reference internal" href="20A_MCMC.html">Metropolis and Gibbs Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="20B_AuxiliaryVariableMCMC.html">Using Auxiliary Variables in MCMC proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extras_01_The_Humble_For_Loop.html">Bonus Material: The Humble For Loop</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extras_02_Functional_Word_Counting.html">Bonus Material: Word count</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extras_03_Symbolic_Algebra.html">Symbolic Algebra with <code class="docutils literal"><span class="pre">sympy</span></code></a></li>
</ul>
</div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="16_PGM.html"
                          title="Previous page">&larr; Probabilistic Graphical Models with <code class="docutils literal"><span class="pre">pgmpy</span></code></a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="17A_Intermediate_Sized_Data.html"
                          title="Next page">&rarr; Biggish Data</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/17_Functional_Programming.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="http://people.duke.edu/~ccc14/sta-663-2017/search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="17A_Intermediate_Sized_Data.html" title="Biggish Data"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="16_PGM.html" title="Probabilistic Graphical Models with pgmpy"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="index-2.html">STA-663-2017 1.0 documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Cliburn Chan and Janice McCarthy.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>

<!-- Mirrored from people.duke.edu/~ccc14/sta-663-2017/17_Functional_Programming.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Apr 2017 01:13:16 GMT -->
</html>