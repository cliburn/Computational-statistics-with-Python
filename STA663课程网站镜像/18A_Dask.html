

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from people.duke.edu/~ccc14/sta-663-2017/18A_Dask.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Apr 2017 01:13:24 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Working with large data sets &#8212; STA-663-2017 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/cloud.base.js"></script>
    <script type="text/javascript" src="_static/cloud.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using Spark" href="18B_Spark.html" />
    <link rel="prev" title="Efficient storage of data in memory" href="17B_Big_Data_Structures.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="18B_Spark.html" title="Using Spark"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="17B_Big_Data_Structures.html" title="Efficient storage of data in memory"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="index-2.html">STA-663-2017 1.0 documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
<div class="section" id="working-with-large-data-sets">
<h1>Working with large data sets<a class="headerlink" href="#working-with-large-data-sets" title="Permalink to this headline">¶</a></h1>
<div class="section" id="small-scale-distributed-programming">
<h2>Small-scale distributed programming<a class="headerlink" href="#small-scale-distributed-programming" title="Permalink to this headline">¶</a></h2>
<div class="section" id="using-dask">
<h3>Using <code class="docutils literal"><span class="pre">dask</span></code><a class="headerlink" href="#using-dask" title="Permalink to this headline">¶</a></h3>
<p>For data sets that are not too big (say up to 1 TB), it is typically
sufficient to process on a single workstation. The package dask provides
3 data structures that mimic regular Python data structures but perform
computation in a distributed way allowing you to make optimal use of
multiple cores easily.</p>
<p>These structures are</p>
<ul class="simple">
<li>dask array ~ numpy array</li>
<li>dask bag ~ Python dictionary</li>
<li>dask dataframe ~ pandas dataframe</li>
</ul>
<p>From the <a class="reference external" href="http://dask.pydata.org/en/latest/index.html">official
documentation</a>,</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Dask</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">task</span> <span class="n">scheduling</span> <span class="n">system</span> <span class="n">that</span> <span class="n">uses</span> <span class="n">directed</span> <span class="n">acyclic</span> <span class="n">graphs</span> <span class="p">(</span><span class="n">DAGs</span><span class="p">)</span> <span class="n">of</span> <span class="n">tasks</span> <span class="n">to</span> <span class="k">break</span> <span class="n">up</span> <span class="n">large</span> <span class="n">computations</span> <span class="n">into</span> <span class="n">many</span> <span class="n">small</span> <span class="n">ones</span><span class="o">.</span>

<span class="n">Dask</span> <span class="n">enables</span> <span class="n">parallel</span> <span class="n">computing</span> <span class="n">through</span> <span class="n">task</span> <span class="n">scheduling</span> <span class="ow">and</span> <span class="n">blocked</span> <span class="n">algorithms</span><span class="o">.</span> <span class="n">This</span> <span class="n">allows</span> <span class="n">developers</span> <span class="n">to</span> <span class="n">write</span>    <span class="nb">complex</span> <span class="n">parallel</span> <span class="n">algorithms</span> <span class="ow">and</span> <span class="n">execute</span> <span class="n">them</span> <span class="ow">in</span> <span class="n">parallel</span> <span class="n">either</span> <span class="n">on</span> <span class="n">a</span> <span class="n">modern</span> <span class="n">multi</span><span class="o">-</span><span class="n">core</span> <span class="n">machine</span> <span class="ow">or</span> <span class="n">on</span> <span class="n">a</span> <span class="n">distributed</span> <span class="n">cluster</span><span class="o">.</span>

<span class="n">On</span> <span class="n">a</span> <span class="n">single</span> <span class="n">machine</span> <span class="n">dask</span> <span class="n">increases</span> <span class="n">the</span> <span class="n">scale</span> <span class="n">of</span> <span class="n">comfortable</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">fits</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">memory</span> <span class="n">to</span> <span class="n">fits</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">disk</span> <span class="n">by</span> <span class="n">intelligently</span> <span class="n">streaming</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">disk</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">leveraging</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">cores</span> <span class="n">of</span> <span class="n">a</span> <span class="n">modern</span> <span class="n">CPU</span><span class="o">.</span>
</pre></div>
</div>
<p>For interesting examples of <code class="docutils literal"><span class="pre">dask</span></code> in practice, see <a class="reference external" href="http://matthewrocklin.com/blog/">Matthew Rocklin&#8217;s
blog</a>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>! pip install dask
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Requirement</span> <span class="n">already</span> <span class="n">satisfied</span><span class="p">:</span> <span class="n">dask</span> <span class="ow">in</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
<span class="kn">import</span> <span class="nn">dask.bag</span> <span class="k">as</span> <span class="nn">db</span>
<span class="kn">import</span> <span class="nn">dask.dataframe</span> <span class="k">as</span> <span class="nn">dd</span>
<span class="kn">from</span> <span class="nn">dask</span> <span class="k">import</span> <span class="n">delayed</span>
</pre></div>
</div>
</div>
<div class="section" id="dask-arrays">
<h3><code class="docutils literal"><span class="pre">dask</span></code> arrays<a class="headerlink" href="#dask-arrays" title="Permalink to this headline">¶</a></h3>
<p>These behave like <code class="docutils literal"><span class="pre">numpy</span></code> arrays, but break a massive job into
<strong>tasks</strong> that are then executed by a <strong>scheduler</strong>. The default
scheduler uses threading but you can also use multiprocessing or
distributed or even serial processing (mainly for debugging). You can
tell the dask array how to break the data into <strong>chunks</strong> for
processing.</p>
<p>From official documents</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>For performance, a good choice of chunks follows the following rules:

A chunk should be small enough to fit comfortably in memory. We’ll have many chunks in memory at once.
A chunk must be large enough so that computations on that chunk take significantly longer than the 1ms overhead per task that dask scheduling incurs. A task should take longer than 100ms.
Chunks should align with the computation that you want to do. For example if you plan to frequently slice along a particular dimension then it’s more efficient if your chunks are aligned so that you have to touch fewer chunks. If you want to add two arrays then its convenient if those arrays have matching chunks patterns.
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># We resuse the 100 * 1000 * 1000 random numbers in the memmap file on disk</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;random.dat&#39;</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># We can decide on the chunk size to be distributed for computing</span>
<span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">fp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">500</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
<span class="n">avg</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">---------------------------------------------------------------------------</span>

<span class="ne">FileNotFoundError</span>                         <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="mi">5</span><span class="n">adc8ca9ee0a</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
      <span class="mi">3</span> <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;random.dat&#39;</span>
      <span class="mi">4</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="o">----&gt;</span> <span class="mi">5</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
      <span class="mi">6</span>
      <span class="mi">7</span> <span class="c1"># We can decide on the chunk size to be distributed for computing</span>


<span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">cliburn</span><span class="o">/</span><span class="n">anaconda2</span><span class="o">/</span><span class="n">envs</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">memmap</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">__new__</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="mi">219</span>             <span class="n">own_file</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="mi">220</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">221</span>             <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span> <span class="ow">and</span> <span class="s1">&#39;r&#39;</span> <span class="ow">or</span> <span class="n">mode</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="mi">222</span>             <span class="n">own_file</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="mi">223</span>


<span class="ne">FileNotFoundError</span><span class="p">:</span> <span class="p">[</span><span class="n">Errno</span> <span class="mi">2</span><span class="p">]</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span><span class="p">:</span> <span class="s1">&#39;random.dat&#39;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">avg</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Typically we store Dask arrays inot HDF5</span>

<span class="n">da</span><span class="o">.</span><span class="n">to_hdf5</span><span class="p">(</span><span class="s1">&#39;data/xs.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;/foo/xs&#39;</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s1">&#39;data/xs.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/foo/xs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="dask-data-frames">
<h3><code class="docutils literal"><span class="pre">dask</span></code> data frames<a class="headerlink" href="#dask-data-frames" title="Permalink to this headline">¶</a></h3>
<p>Dask dataframes can treat multiple pandas dataframes that might not
simultaneously fit into memory like a single dataframe. See use of
globbing to specify multiple source files.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;data/x</span><span class="si">%03d</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/x*.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="dask-bags">
<h3><code class="docutils literal"><span class="pre">dask</span></code> bags<a class="headerlink" href="#dask-bags" title="Permalink to this headline">¶</a></h3>
<p>Dask bags work like multisets for unstructured or semi-structured data
sets, typically over many files. A multiset is a set that allows
repeats. Unlike lists, order is not preserved.</p>
<p>The dask bag is often used for preprocessing data before conversion to
the more efficient array or dataframe collections. Manipulating dask
bags has a functional flavor, similar to using <code class="docutils literal"><span class="pre">toolz</span></code> for standard
Python collections.</p>
<div class="section" id="creating-a-bag">
<h4>Creating a bag<a class="headerlink" href="#creating-a-bag" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">bag</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">from_sequence</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">bag</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="the-aa-subdirectory-consists-of-101-1-mb-plain-text-files-from-the-english-wikipedia">
<h4>The AA subdirectory consists of 101 1 MB plain text files from the English Wikipedia<a class="headerlink" href="#the-aa-subdirectory-consists-of-101-1-mb-plain-text-files-from-the-english-wikipedia" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s1">&#39;data/wiki/AA/*&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>

<span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">top10</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">top10</span><span class="p">)</span>
</pre></div>
</div>
<p>This is slow because of disk access. Fix by changing scheduler to work
asynchronously.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">time</span>

<span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">frequencies</span><span class="p">()</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">top10</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">get</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="k">async</span><span class="o">.</span><span class="n">get_sync</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">top10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="conversion-from-bag-to-dataframe">
<h4>Conversion from bag to dataframe<a class="headerlink" href="#conversion-from-bag-to-dataframe" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">freqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="o">.</span>
         <span class="nb">str</span><span class="o">.</span><span class="n">translate</span><span class="p">({</span><span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">):</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">})</span><span class="o">.</span>
         <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span>
         <span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span><span class="o">.</span>
         <span class="n">concat</span><span class="p">()</span><span class="o">.</span>
         <span class="n">frequencies</span><span class="p">())</span>
</pre></div>
</div>
<div class="section" id="get-the-top-5-words-sorted-by-key-not-value">
<h5>Get the top 5 words sorted by key (not value)<a class="headerlink" href="#get-the-top-5-words-sorted-by-key-not-value" title="Permalink to this headline">¶</a></h5>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">freqs</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">get</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="k">async</span><span class="o">.</span><span class="n">get_sync</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df_freqs</span> <span class="o">=</span> <span class="n">freqs</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">])</span>
<span class="n">df_freqs</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-compute-method-converts-to-a-regular-pandas-dataframe">
<h4>The compute method converts to a regular pandas dataframe<a class="headerlink" href="#the-compute-method-converts-to-a-regular-pandas-dataframe" title="Permalink to this headline">¶</a></h4>
<p>For data sets that fit in memory, pandas is faster and allows some
operations like sorting that are not provided by dask dataframes.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_freqs</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dask-delayed">
<h3>dask delayed<a class="headerlink" href="#dask-delayed" title="Permalink to this headline">¶</a></h3>
<p>For full custom pipelines, you can use the delayed function. This just
wraps standard Python functions so that they are not evaluated until
called upon to do so by the scheduler. You can think of delayed as
converting an eager function to a lazy one. You generally used delayed
when the processing task is not easily doable with any of the array, bag
or data frame abstractions, since you have the full power of Python with
delayed.</p>
<p>It is easy to convert to and from delayed with the array, bag or data
frame parallel data structures using the <code class="docutils literal"><span class="pre">to_delayed()</span></code> and
<code class="docutils literal"><span class="pre">from_delayted()</span></code> methods.</p>
<p>We will show the simple example provided in the <code class="docutils literal"><span class="pre">dask</span></code> documentation.</p>
<p>def inc(x): return x + 1</p>
<p>def double(x): return x + 2</p>
<p>def add(x, y): return x + y</p>
<p>data = [1, 2, 3, 4, 5]</p>
<p>output = [] for x in data: a = delayed(inc)(x) b = delayed(double)(x) c
= delayed(add)(a, b) output.append(c)</p>
<p>total = delayed(sum)(output)</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">total</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="the-dag-directed-acyclic-graph-of-tasks-built-by-dask">
<h4>The DAG (directed acyclic graph) of tasks built by dask<a class="headerlink" href="#the-dag-directed-acyclic-graph-of-tasks-built-by-dask" title="Permalink to this headline">¶</a></h4>
<p>Using this graph, the scheduler can identify opportunities for
parallelism.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">total</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="minimizing-computation-of-intermediate-objects">
<h4>Minimizing computation of intermediate objects<a class="headerlink" href="#minimizing-computation-of-intermediate-objects" title="Permalink to this headline">¶</a></h4>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">da</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-the-web-interface">
<h3>Using the web interface<a class="headerlink" href="#using-the-web-interface" title="Permalink to this headline">¶</a></h3>
<p>See
<a class="reference external" href="https://distributed.readthedocs.io/en/latest/web.html#connecting-to-web-interface">docs</a></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span>! pip install distributed
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="index-2.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="00_Jupyter.html">Notes on using Jupyter</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_Introduction_To_Python.html">Introduction to Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_Functions.html">Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_Classes.html">Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_Strings.html">Strings</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_Numbers.html">Using <code class="docutils literal"><span class="pre">numpy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="06_Graphics.html">Graphics in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_Data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_SQL.html">SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_Machine_Learning.html">Machine Learning with <code class="docutils literal"><span class="pre">sklearn</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="10A_CodeOptimization.html">Code Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="10B_Numba.html">Just-in-time compilation (JIT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="10C_Cython.html">Cython</a></li>
<li class="toctree-l1"><a class="reference internal" href="11A_Parallel_Programming.html">Parallel Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="11B_Threads_Processses_Concurrency.html">Multi-Core Parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="11C_IPyParallel.html">Using <code class="docutils literal"><span class="pre">ipyparallel</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="12A_C%2b%2b.html">Using C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="12B_C%2b%2b_Python_pybind11.html">Using <code class="docutils literal"><span class="pre">pybind11</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="13A_LinearAlgebra1.html">Linear Algebra Review</a></li>
<li class="toctree-l1"><a class="reference internal" href="13A_LinearAlgebra1.html#linear-algebra-and-linear-systems">Linear Algebra and Linear Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="13B_LinearAlgebra2.html">Matrix Decompositions</a></li>
<li class="toctree-l1"><a class="reference internal" href="13C_LinearAlgebraExamples.html">Linear Algebra Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="13D_PCA.html">Applications of Linear Alebra: PCA</a></li>
<li class="toctree-l1"><a class="reference internal" href="13E_SparseMatrices.html">Sparse Matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="14A_Optimization_One_Dimension.html">Optimization and Root Finding</a></li>
<li class="toctree-l1"><a class="reference internal" href="14B_Multivariate_Optimization.html">Algorithms for Optimization and Root Finding for Multivariate Problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="14C_Optimization_In_Python.html">Using optimization routines from <code class="docutils literal"><span class="pre">scipy</span></code> and <code class="docutils literal"><span class="pre">statsmodels</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="15A_Random_Numbers.html">Random numbers and probability models</a></li>
<li class="toctree-l1"><a class="reference internal" href="15B_ResamplingAndSimulation.html">Resampling and Monte Carlo Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="15C_MonteCarloIntegration.html">Numerical Evaluation of Integrals</a></li>
<li class="toctree-l1"><a class="reference internal" href="16_PGM.html">Probabilistic Graphical Models with <code class="docutils literal"><span class="pre">pgmpy</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="17_Functional_Programming.html">Working with large data sets</a></li>
<li class="toctree-l1"><a class="reference internal" href="17A_Intermediate_Sized_Data.html">Biggish Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="17B_Big_Data_Structures.html">Efficient storage of data in memory</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Working with large data sets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#small-scale-distributed-programming">Small-scale distributed programming</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="10B_Numba.html">Just-in-time compilation (JIT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="18B_Spark.html">Using Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="18C_Efficiency_In_Spark.html">Using Spark Efficiently</a></li>
<li class="toctree-l1"><a class="reference internal" href="18D_Spark_MLib.html">Spark MLLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="18E_Spark_SQL.html">Spark SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="18G_Spark_Streaming.html">Spark Streaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="18H_Spark_Cloud.html">Spark on Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="19A_PyMC3.html">Using PyMC3</a></li>
<li class="toctree-l1"><a class="reference internal" href="19B_Pystan.html">PyStan</a></li>
<li class="toctree-l1"><a class="reference internal" href="20A_MCMC.html">Metropolis and Gibbs Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="20B_AuxiliaryVariableMCMC.html">Using Auxiliary Variables in MCMC proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extras_01_The_Humble_For_Loop.html">Bonus Material: The Humble For Loop</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extras_02_Functional_Word_Counting.html">Bonus Material: Word count</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extras_03_Symbolic_Algebra.html">Symbolic Algebra with <code class="docutils literal"><span class="pre">sympy</span></code></a></li>
</ul>
</div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="17B_Big_Data_Structures.html"
                          title="Previous page">&larr; Efficient storage of data in memory</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="18B_Spark.html"
                          title="Next page">&rarr; Using Spark</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/18A_Dask.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="http://people.duke.edu/~ccc14/sta-663-2017/search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="18B_Spark.html" title="Using Spark"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="17B_Big_Data_Structures.html" title="Efficient storage of data in memory"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="index-2.html">STA-663-2017 1.0 documentation</a> &#187;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Cliburn Chan and Janice McCarthy.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>

<!-- Mirrored from people.duke.edu/~ccc14/sta-663-2017/18A_Dask.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Apr 2017 01:13:26 GMT -->
</html>